#include <Arduino.h>
#include <Wire.h>
#include <SPI.h>

// 引入感測器函式庫
#include "Adafruit_SHT31.h"
#include "Adafruit_BMP3XX.h"
#include "Adafruit_Sensor.h"
#include "Adafruit_ADXL375.h"
#include "ICM42688.h"

// --- 定義 I2C 腳位 (請依您的 ESP32 接腳修改) ---
// ESP32 一般預設: SDA=21, SCL=22
// ESP32-S3 一般預設: SDA=8, SCL=9 或其他，請查閱您的板子圖
#define I2C_SDA 8
#define I2C_SCL 9

// --- 建立感測器物件 ---
Adafruit_SHT31 sht31 = Adafruit_SHT31();
Adafruit_BMP3XX bmp;
Adafruit_ADXL375 accel = Adafruit_ADXL375(12345); // ID 隨意
ICM42688 imu(Wire, 0x68); // IMU42688 地址通常是 0x68 或 0x69

// --- 狀態旗標 (檢查誰活著) ---
bool status_sht = false;
bool status_bmp = false;
bool status_adxl = false;
bool status_imu = false;

void setup() {
  Serial.begin(115200);
  while (!Serial); // 等待串口連接
  delay(1000);
  
  Serial.println("\n=== Rocket Avionics Sensor Test ===");
  
  // 初始化 I2C
  Wire.begin(I2C_SDA, I2C_SCL);
  // 可選：提高 I2C 速度到 400kHz (Fast Mode)
  Wire.setClock(400000); 

  // 1. 初始化 SHT31 (溫濕度)
  Serial.print("Initializing SHT31... ");
  if (!sht31.begin(0x44)) {   // 預設地址 0x44
    Serial.println("FAILED!");
  } else {
    Serial.println("OK!");
    status_sht = true;
  }

  // 2. 初始化 BMP390 (氣壓/高度)
  Serial.print("Initializing BMP390... ");
  if (!bmp.begin_I2C()) {   // 自動偵測地址 0x77 或 0x76
    Serial.println("FAILED! (Check wiring or Addr)");
  } else {
    Serial.println("OK!");
    status_bmp = true;
    // 設定 BMP390 採樣參數 (適合火箭的高速採樣)
    bmp.setTemperatureOversampling(BMP3_OVERSAMPLING_8X);
    bmp.setPressureOversampling(BMP3_OVERSAMPLING_4X);
    bmp.setIIRFilterCoeff(BMP3_IIR_FILTER_COEFF_3);
    bmp.setOutputDataRate(BMP3_ODR_50_HZ);
  }

  // 3. 初始化 ADXL375 (高 G 值加速度計)
  Serial.print("Initializing ADXL375... ");
  if(!accel.begin()) {
    Serial.println("FAILED!");
  } else {
    Serial.println("OK!");
    status_adxl = true;
  }

  // 4. 初始化 IMU42688 (陀螺儀/加速度計)
  Serial.print("Initializing ICM-42688... ");
  int imu_status = imu.begin();
  if (imu_status < 0) {
    Serial.println("FAILED!");
  } else {
    Serial.println("OK!");
    status_imu = true;
    // 設定 IMU 範圍 (火箭通常需要最大範圍)
    imu.setAccelFS(ICM42688::gpm16); // ±16g
    imu.setGyroFS(ICM42688::dps2000); // ±2000 dps
  }
  
  Serial.println("=== Initialization Finished ===\n");
  delay(1000);
}

void loop() {
  Serial.println("------------------------------------------------");
  
  // --- 讀取 SHT31 ---
  if (status_sht) {
    float t = sht31.readTemperature();
    float h = sht31.readHumidity();
    Serial.print("[SHT31] Temp: "); Serial.print(t); Serial.print(" C, Hum: "); Serial.print(h); Serial.println(" %");
  }

  // --- 讀取 BMP390 ---
  if (status_bmp) {
    if (bmp.performReading()) {
      Serial.print("[BMP390] Press: "); Serial.print(bmp.pressure / 100.0); Serial.print(" hPa, Alt: "); Serial.print(bmp.readAltitude(1013.25)); Serial.println(" m");
    }
  }

  // --- 讀取 ADXL375 ---
  if (status_adxl) {
    sensors_event_t event;
    accel.getEvent(&event);
    // ADXL375 主要是看 Z 軸 (垂直發射方向)
    Serial.print("[ADXL375] X: "); Serial.print(event.acceleration.x);
    Serial.print("  Y: "); Serial.print(event.acceleration.y);
    Serial.print("  Z: "); Serial.print(event.acceleration.z); Serial.println(" m/s^2");
  }

  // --- 讀取 IMU42688 ---
  if (status_imu) {
    imu.getAGT(); // 更新數據
    Serial.print("[IMU42688] Acc X:"); Serial.print(imu.accX());
    Serial.print(" Y:"); Serial.print(imu.accY());
    Serial.print(" Z:"); Serial.print(imu.accZ());
    Serial.print(" | Gyro X:"); Serial.print(imu.gyrX());
    Serial.print(" Y:"); Serial.print(imu.gyrY());
    Serial.print(" Z:"); Serial.println(imu.gyrZ());
  }

  // 簡易延遲，方便肉眼觀察 (實際飛行時不能用 delay)
  delay(200); 
}